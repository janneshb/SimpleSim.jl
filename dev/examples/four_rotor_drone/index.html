<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Four-Rotor Drone · SimpleSim.jl</title><meta name="title" content="Four-Rotor Drone · SimpleSim.jl"/><meta property="og:title" content="Four-Rotor Drone · SimpleSim.jl"/><meta property="twitter:title" content="Four-Rotor Drone · SimpleSim.jl"/><meta name="description" content="Documentation for SimpleSim.jl."/><meta property="og:description" content="Documentation for SimpleSim.jl."/><meta property="twitter:description" content="Documentation for SimpleSim.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.gif" alt="SimpleSim.jl logo"/><img class="docs-dark-only" src="../../assets/logo-dark.gif" alt="SimpleSim.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SimpleSim.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../overview/exports/">What does <code>SimpleSim.jl</code> export?</a></li><li><a class="tocitem" href="../../overview/ct_sims/">Continuous-Time Models</a></li><li><a class="tocitem" href="../../overview/dt_sims/">Discrete-Time Models</a></li><li><a class="tocitem" href="../../overview/nested_sims/">Nested Models</a></li><li><a class="tocitem" href="../../overview/run_sims/">Simulating Models</a></li><li><a class="tocitem" href="../../overview/output/">Interpreting Output</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../minimal_example/">Minimal Example</a></li><li><a class="tocitem" href="../bouncing_ball/">Bouncing Ball</a></li><li><a class="tocitem" href="../feedback_control/">Feedback Control</a></li><li><a class="tocitem" href="../random_walk/">Random Walk</a></li><li class="is-active"><a class="tocitem" href>Four-Rotor Drone</a><ul class="internal"><li><a class="tocitem" href="#Motors"><span>Motors</span></a></li><li><a class="tocitem" href="#Propellers"><span>Propellers</span></a></li><li><a class="tocitem" href="#RPM-Sensors"><span>RPM Sensors</span></a></li><li><a class="tocitem" href="#&quot;Powered&quot;-Propellers"><span>&quot;Powered&quot; Propellers</span></a></li><li><a class="tocitem" href="#Airframe"><span>Airframe</span></a></li><li><a class="tocitem" href="#The-Rigid-Body"><span>The Rigid Body</span></a></li><li><a class="tocitem" href="#GPS,-Accelerometer-and-Gyroscope"><span>GPS, Accelerometer and Gyroscope</span></a></li><li><a class="tocitem" href="#The-Control-System"><span>The Control System</span></a></li><li><a class="tocitem" href="#Putting-it-all-together"><span>Putting it all together</span></a></li></ul></li></ul></li><li><span class="tocitem">Running Simulations</span><ul><li><a class="tocitem" href="../../functions/standalone_sim/">Standalone Simulations</a></li><li><a class="tocitem" href="../../functions/nested_sim/">Nested Simulations</a></li><li><a class="tocitem" href="../../functions/random_vars/">Random Variables</a></li><li><a class="tocitem" href="../../functions/zero_crossing/">Zero-Crossing Detection</a></li></ul></li><li><span class="tocitem">Output Handling</span><ul><li><a class="tocitem" href="../../output/simulation_output/">Simulation Output</a></li><li><a class="tocitem" href="../../output/log/"><code>@log</code> macro</a></li></ul></li><li><span class="tocitem">Integrators</span><ul><li><a class="tocitem" href="../../integrators/overview/">Overview</a></li><li><a class="tocitem" href="../../integrators/euler/">Euler</a></li><li><a class="tocitem" href="../../integrators/heun/">Heun</a></li><li><a class="tocitem" href="../../integrators/rk4/">4th Order Runge-Kutta</a></li><li><a class="tocitem" href="../../integrators/rkf45/">Runge-Kutta-Fehlberg</a></li></ul></li><li><a class="tocitem" href="../../misc/">Miscellaneous</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Four-Rotor Drone</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Four-Rotor Drone</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/janneshb/SimpleSim.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/janneshb/SimpleSim.jl/blob/main/docs/src/examples/four_rotor_drone.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Four-Rotor-Drone"><a class="docs-heading-anchor" href="#Four-Rotor-Drone">Four-Rotor Drone</a><a id="Four-Rotor-Drone-1"></a><a class="docs-heading-anchor-permalink" href="#Four-Rotor-Drone" title="Permalink"></a></h1><p>In this example, a four-rotor drone, just as the ones you can buy from various manufacturers, is set up. The drone involves the following individual models:</p><ul><li>a rigid body</li><li>motors</li><li>propellers</li><li>sensors</li><li>a control system</li></ul><p>Some of these models only consist of continuous-time or discrete-time dynamics, other might have both.</p><p>Of course, the system&#39;s complexity can be increased arbitrarily.</p><h2 id="Motors"><a class="docs-heading-anchor" href="#Motors">Motors</a><a id="Motors-1"></a><a class="docs-heading-anchor-permalink" href="#Motors" title="Permalink"></a></h2><p>The motors&#39; RPM are modeled as second-order systems with time-constant <span>$\tau$</span>, damping <span>$\zeta$</span> and gain <span>$k$</span>.</p><p class="math-container">\[\tau \frac{d^2 \omega}{d t^2} + 2 \zeta \tau \frac{d\omega}{dt} + \omega = k \cdot r_\omega(t)\]</p><p>The reference RPM supplied by the control system forms the motor input.</p><p>For <code>SimpleSim.jl</code> we need to cast this ODE into a system of first-order ODEs. The state then consists of the RPM <span>$\omega$</span> and its derivative <span>$\dot{\omega}$</span>.</p><pre><code class="language-julia hljs">function fc_motor(ω, r_ω, p, t)
    ω_d = ω[2]
    ω_dd = (p.k * r_ω - 2 * p.ζ * p.τ * ω[1]) / p.τ

    if ω[1] &gt;= p.rpm_max || ω[1] &lt;= 0.0
        ω_d = 0.0
        ω_dd = 0.0
    end

    return [ω_d, ω_dd]
end</code></pre><p>The output only contains the current RPM.</p><pre><code class="language-julia hljs">yc_motor = (ω, r_ω, p, t) -&gt; p.direction * ω[1]</code></pre><p>We can then create a motor model. The parameters <span>$\tau$</span>, <span>$\zeta$</span> and <span>$k$</span> are identified using system identification techniques. All motors are assumed to standing still at the beginning of the simulation.</p><pre><code class="language-julia hljs">motor_1 = (
    p = (
        τ = 1 / 800.0^2,
        ζ = 0.15,
        k = 1.0,
        rpm_max = 20_000*2*π,
        direction = 1.0,
    ),
    fc = fc_motor,
    yc = yc_motor,
    xc0 = [0.0, 0.0],
    uc0 = 0.0,
)</code></pre><p>All four motors are basically identical. Hence, we copy the model we already have to get all four motor models.</p><pre><code class="language-julia hljs">motor_2 = motor_1
motor_3 = motor_1
motor_4 = motor_1</code></pre><p>We only need to adjust the direction of rotation for motor 2 and 4.</p><pre><code class="language-julia hljs">motor_2 = (motor_2..., p = (motor_2.p..., direction = -1.0))
motor_4 = (motor_4..., p = (motor_4.p..., direction = -1.0))</code></pre><p><em>Note:</em> we are speaking about RPM, but <span>$ω$</span> is actually measured in radians per second.</p><h2 id="Propellers"><a class="docs-heading-anchor" href="#Propellers">Propellers</a><a id="Propellers-1"></a><a class="docs-heading-anchor-permalink" href="#Propellers" title="Permalink"></a></h2><p>We expect propellers to generate linear force (thrust) and torque as a function of the current RPM of the rotor. RPM is therefore an input of a rotor model, thrust and torque are the output.</p><p>Thrust always acts downwards in the drone&#39;s frame of reference. Torque depends only on the direction of rotation of the propeller. Hence, we can use scalar values as ouputs of the propeller model.</p><pre><code class="language-julia hljs">fc_prop = (x, ω, p, t) -&gt; nothing

yc_prop = (x, ω, p, t) -&gt; [p.k_f2 * ω^2, p.k_t * ω]</code></pre><p>We expect thrust to be proportional to the square of the rate of rotation, while torque behaves approximately linear with respect to <span>$\omega$</span>. The slopes <span>$k_{f, 2}$</span> and <span>$k_t$</span> are given as parameters.</p><pre><code class="language-julia hljs">prop_1 = (
    p = (
        k_f2 = 5e-7,
        k_t = 2e-5,
    ),
    fc = fc_prop,
    yc = yc_prop,
    uc0 = 0.0,
)
prop_2 = prop_1
prop_3 = prop_1
prop_4 = prop_1</code></pre><h2 id="RPM-Sensors"><a class="docs-heading-anchor" href="#RPM-Sensors">RPM Sensors</a><a id="RPM-Sensors-1"></a><a class="docs-heading-anchor-permalink" href="#RPM-Sensors" title="Permalink"></a></h2><p>We assume the motors provide RPM feedback. But the sensor for that is digital and only updates at a frequency of 100Hz.</p><pre><code class="language-julia hljs">fd_sensor = (x, ω, p, t) -&gt; nothing

yd_sensor = (x, ω, p, t) -&gt; ω

sensor_1 = (
    p = nothing,
    fd = fd_sensor,
    yd = yd_sensor,
    Δt = 1 // 100,
    ud0 = 0.0,
)
sensor_2 = sensor_1
sensor_3 = sensor_1
sensor_4 = sensor_1</code></pre><p>Naturally, all sensors should be purely discrete-time.</p><h2 id="&quot;Powered&quot;-Propellers"><a class="docs-heading-anchor" href="#&quot;Powered&quot;-Propellers">&quot;Powered&quot; Propellers</a><a id="&quot;Powered&quot;-Propellers-1"></a><a class="docs-heading-anchor-permalink" href="#&quot;Powered&quot;-Propellers" title="Permalink"></a></h2><p>This model is not strictly necessary. However, to showcase the modularity of <code>SimpleSim.jl</code> we will wrap a motor, propeller and RPM sensor</p><pre><code class="language-julia hljs">fc_powered_prop = (x, u, p, t; models) -&gt; nothing

function yc_powered_prop(x, r_ω, p, t; models)
    ω = @call! models.motor r_ω
    ft = @call! models.prop ω
    ω_measurement = @call! models.sensor ω

    return [ft..., ω_measurement...]
end

powered_prop_1 = (
    p = nothing,
    fc = fc_powered_prop,
    yc = yc_powered_prop,
    uc0 = 0.0,
    models = (
        motor = motor_1,
        prop = prop_1,
        sensor = rpm_sensor_1,
    )
)

powered_prop_2 = (powered_prop_1...,
    models = (
        motor = motor_2,
        prop = prop_2,
        sensor = rpm_sensor_2,
    )
)

powered_prop_3 = # ...</code></pre><p>A <code>powered_prop</code> is a continuous-time model, taking a reference RPM as input. It then calls the motor model, computes the thrust and torque generated using the prop model and returns the force, torque and the sensor measurement of the current RPM.</p><h2 id="Airframe"><a class="docs-heading-anchor" href="#Airframe">Airframe</a><a id="Airframe-1"></a><a class="docs-heading-anchor-permalink" href="#Airframe" title="Permalink"></a></h2><p>To gather the motor and propeller models, we define a state-less airframe model that simply computes the overall force and torque acting on the system, given four reference RPM values.</p><p>Note, that since the propellers are excerted from the drone&#39;s center of gravity they need to be included in the computation of the total torque acting on the system.</p><pre><code class="language-julia hljs">fc_airframe = (x, u, p, t; models) -&gt; nothing

function yc_airframe(x, r_ω, p, t; models)
    ft_ω_1 = @call! models.powered_prop_1 r_ω[1]
    ft_ω_2 = @call! models.powered_prop_2 r_ω[2]
    ft_ω_3 = @call! models.powered_prop_3 r_ω[3]
    ft_ω_4 = @call! models.powered_prop_4 r_ω[4]

    # compute the total thrust in the drone&#39;s frame of reference
    f_total_B = [0, 0, - ft_ω_1[1] - ft_ω_2[1] - ft_ω_3[1] - ft_ω_4[1]]

    # compute total total torque
    t_aero_B = [0, 0, ft_ω_1[2] + ft_ω_2[2] + ft_ω_3[2] + ft_ω_4[2]]
    t_thrust_B = p.x_prop_1_B × [0, 0, ft_ω_1[1]] + p.x_prop_2_B × [0, 0, ft_ω_2[1]] + p.x_prop_3_B × [0, 0, ft_ω_3[1]] + p.x_prop_4_B × [0, 0, ft_ω_4[1]]

    return vcat(f_total_B, t_aero_B + t_thrust_B, ft_ω_1[end], ft_ω_2[end], ft_ω_3[end], ft_ω_4[end])
end

airframe = (
    p = (
        x_prop_1_B = [10e-2, 10e-2, 0.0],
        x_prop_2_B = [-10e-2, 10e-2, 0.0],
        x_prop_3_B = [-10e-2, -10e-2, 0.0],
        x_prop_4_B = [10e-2, -10e-2, 0.0],
    ),
    fc = fc_airframe,
    yc = yc_airframe,
    uc0 = [0.0, 0.0, 0.0, 0.0],
    models = (
        powered_prop_1 = powered_prop_1,
        powered_prop_2 = powered_prop_2,
        powered_prop_3 = powered_prop_3,
        powered_prop_4 = powered_prop_4,
    ),
)</code></pre><h2 id="The-Rigid-Body"><a class="docs-heading-anchor" href="#The-Rigid-Body">The Rigid Body</a><a id="The-Rigid-Body-1"></a><a class="docs-heading-anchor-permalink" href="#The-Rigid-Body" title="Permalink"></a></h2><p>The drone itself of course has rigid body dynamics. These are pretty straigtforward to model.</p><p>The rigid-body inputs are the sum of all forces and moments acting on the body in its own frame of reference. The output is its current position and velocity in the inertial frame and its Euler angles, as well as angular rates.</p><pre><code class="language-julia hljs">function fc_rigid_body(x, u, p, t)

end

yc_rigid_body = (x, u, p, t) -&gt; x

rigid_body = (
    p = (
        m = 0.3,
        J = [

        ],
    ),
    fc = fc_rigid_body,
    yc = yc_rigid_body,
    xc0 = [],
    uc0 = [],
)</code></pre><h2 id="GPS,-Accelerometer-and-Gyroscope"><a class="docs-heading-anchor" href="#GPS,-Accelerometer-and-Gyroscope">GPS, Accelerometer and Gyroscope</a><a id="GPS,-Accelerometer-and-Gyroscope-1"></a><a class="docs-heading-anchor-permalink" href="#GPS,-Accelerometer-and-Gyroscope" title="Permalink"></a></h2><h2 id="The-Control-System"><a class="docs-heading-anchor" href="#The-Control-System">The Control System</a><a id="The-Control-System-1"></a><a class="docs-heading-anchor-permalink" href="#The-Control-System" title="Permalink"></a></h2><h2 id="Putting-it-all-together"><a class="docs-heading-anchor" href="#Putting-it-all-together">Putting it all together</a><a id="Putting-it-all-together-1"></a><a class="docs-heading-anchor-permalink" href="#Putting-it-all-together" title="Permalink"></a></h2><pre><code class="language-julia hljs">the_drone = (
    models = (
        airframe = airframe,
    )
)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../random_walk/">« Random Walk</a><a class="docs-footer-nextpage" href="../../functions/standalone_sim/">Standalone Simulations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Thursday 5 September 2024 19:36">Thursday 5 September 2024</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
